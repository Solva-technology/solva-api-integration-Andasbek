# ü§ñ Telegram Weather & RPS Bot

–¢–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç –Ω–∞ **aiogram 3.x**, –∫–æ—Ç–æ—Ä—ã–π —É–º–µ–µ—Ç:

* –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–≥–æ–¥—É —á–µ—Ä–µ–∑ **OpenWeatherMap API** (–¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ MongoDB).
* –ò–≥—Ä–∞—Ç—å –≤ **¬´–ö–∞–º–µ–Ω—å-–ù–æ–∂–Ω–∏—Ü—ã-–ë—É–º–∞–≥–∞¬ª** —á–µ—Ä–µ–∑ inline-–∫–Ω–æ–ø–∫–∏.
* –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É: –Ω–µ –±–æ–ª–µ–µ **3 –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–≥–æ–¥—ã –∑–∞ 2 –º–∏–Ω—É—Ç—ã** –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–ü—Ä–æ–µ–∫—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–æ–≤–∞–Ω (Docker, docker-compose), –ª–æ–≥–∏ –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ, –ø–æ–∫—Ä—ã—Ç —Ç–µ—Å—Ç–∞–º–∏.

---

## üìÇ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
app/
  main.py                 # —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
  keyboards/
    inline.py             # inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
  services/
    weather_client.py     # –∫–ª–∏–µ–Ω—Ç OpenWeatherMap (aiohttp)
    mongo_client.py       # –∑–∞–ø–∏—Å—å –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ MongoDB
    rps.py                # –ª–æ–≥–∏–∫–∞ –∏–≥—Ä—ã –ö–ù–ë
    sessions.py           # —Ä–∞–±–æ—Ç–∞ —Å sessions.json (–ª–∏–º–∏—Ç—ã)
  handlers/
    start.py              # –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
    weather.py            # –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–≥–æ–¥—ã
    rps.py                # –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∏–≥—Ä—ã
  utils/
    logging.py            # JSON-–ª–æ–≥–∏
sessions.json             # —Ñ–∞–π–ª –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
tests/
  test_rps.py             # —Ç–µ—Å—Ç—ã –∏–≥—Ä—ã
  test_weather_client.py  # —Ç–µ—Å—Ç—ã –ø–æ–≥–æ–¥—ã (–º–æ–∫–∏)
  test_callbacks.py       # —Ç–µ—Å—Ç—ã –∫–ª–∞–≤–∏–∞—Ç—É—Ä
Dockerfile
docker-compose.yml
requirements.txt
.env.example
README.md
```

---

## ‚öôÔ∏è –°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π

* **Python 3.11+**
* **aiogram 3.x**
* **aiohttp 3.x**
* **MongoDB + motor**
* **mongo-express** (MongoWeiver ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫ –±–∞–∑—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
* **pytest + aioresponses** (—Ç–µ—Å—Ç—ã)
* **Docker, docker-compose**
* **JSON-–ª–æ–≥–∏** —á–µ—Ä–µ–∑ python-json-logger

---

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```bash
git clone https://github.com/your-username/weather-rps-bot.git
cd weather-rps-bot
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ `.env.example` ‚Üí `.env` –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ:

```dotenv
BOT_TOKEN=–≤–∞—à_–±–æ—Ç_—Ç–æ–∫–µ–Ω
OPENWEATHER_API_KEY=–≤–∞—à_api_key
OPENWEATHER_BASE_URL=https://api.openweathermap.org/data/2.5
MONGO_URI=mongodb://mongo:27017
MONGO_DB=weather_bot
LOG_LEVEL=INFO
```

### 3. –ó–∞–ø—É—Å–∫ –≤ Docker

```bash
docker-compose up --build
```

### 4. –î–æ—Å—Ç—É–ø—ã

* **–ë–æ—Ç**: –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Telegram.
* **MongoDB**: `localhost:27017`
* **MongoWeiver (mongo-express)**: [http://localhost:8081](http://localhost:8081) (–ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å: `admin`/`admin`)

---

## üîÑ –°—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–∞–±–æ—Ç—ã

### `/start`

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é:

* ¬´–ü–æ–≥–æ–¥–∞¬ª
* ¬´–ö–ù–ë¬ª

---

### üå§ –ü–æ–≥–æ–¥–∞

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–º—ë—Ç **–ü–æ–≥–æ–¥–∞**.
2. –í–≤–æ–¥–∏—Ç –≥–æ—Ä–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–ê–ª–º–∞—Ç—ã¬ª).
3. –ü–æ–ª—É—á–∞–µ—Ç –∫–Ω–æ–ø–∫—É ¬´–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–≥–æ–¥—É¬ª.
4. –ë–æ—Ç –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ **OpenWeatherMap API**.
5. –†–µ–∑—É–ª—å—Ç–∞—Ç:

   * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
   * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ **MongoDB**.
6. –û—à–∏–±–∫–∏ API (404, 500, timeout) ‚Üí –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
7. ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: –Ω–µ –±–æ–ª–µ–µ **3 –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ 2 –º–∏–Ω—É—Ç—ã** (—á–µ—Ä–µ–∑ `sessions.json`).

---

### ‚úä‚úåÔ∏è‚úã –ö–∞–º–µ–Ω—å-–ù–æ–∂–Ω–∏—Ü—ã-–ë—É–º–∞–≥–∞

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–º—ë—Ç **–ö–ù–ë**.
2. –í—ã–±–∏—Ä–∞–µ—Ç –∂–µ—Å—Ç (–ö–∞–º–µ–Ω—å / –ù–æ–∂–Ω–∏—Ü—ã / –ë—É–º–∞–≥–∞).
3. –ë–æ—Ç —Å–ª—É—á–∞–π–Ω–æ –≤—ã–±–∏—Ä–∞–µ—Ç —Å–≤–æ–π –∂–µ—Å—Ç.
4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–≤—ã–∏–≥—Ä–∞–ª/–ø—Ä–æ–∏–≥—Ä–∞–ª/–Ω–∏—á—å—è) + –∫–Ω–æ–ø–∫–∞ ¬´–°—ã–≥—Ä–∞—Ç—å –µ—â—ë¬ª.

---

## üìÇ –•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

–í—Å–µ —É—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ–≥–æ–¥—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ MongoDB:

```json
{
  "city": "–ê–ª–º–∞—Ç—ã",
  "payload": { ... –ø–æ–ª–Ω—ã–π JSON –æ—Ç–≤–µ—Ç–∞ OWM ... },
  "ts": "2025-09-06T10:17:07Z"
}
```

–ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ [http://localhost:8081](http://localhost:8081).

---

## üß™ –¢–µ—Å—Ç—ã

–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:

```bash
pytest -q
```

* `test_rps.py` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ö–æ–¥–æ–≤ –∏–≥—Ä—ã –ø—Ä–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–º ¬´—Ä–∞–Ω–¥–æ–º–µ¬ª.
* `test_weather_client.py` ‚Äî –º–æ–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ OpenWeather (200, 404, 500, timeout).
* `test_callbacks.py` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ `callback_data` –≤ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞—Ö.

---

## üìù –õ–æ–≥–∏

–í—Å–µ –ª–æ–≥–∏ –ø–∏—à—É—Ç—Å—è –≤ JSON-—Ñ–æ—Ä–º–∞—Ç–µ –Ω–∞ `stdout` (–≤–∏–¥–Ω—ã —á–µ—Ä–µ–∑ `docker logs`).
–ü—Ä–∏–º–µ—Ä:

```json
{"asctime": "2025-09-06 12:00:00,123", "levelname": "INFO", "name": "app", "message": "Bot starting ..."}
```

–£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—ë—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è `LOG_LEVEL` (`INFO`, `DEBUG`, `WARNING` –∏ —Ç.–¥.).

---

## üìä –°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã

```mermaid
flowchart TD
    U[üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å] -->|/start| S[/–ö–æ–º–∞–Ω–¥–∞ start/]
    S --> M[–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞: –ü–æ–≥–æ–¥–∞ / –ö–ù–ë]

    M -->|–ü–æ–≥–æ–¥–∞| W1[–í–≤–æ–¥ –≥–æ—Ä–æ–¥–∞]
    W1 --> W2[weather:get:<city>]
    W2 --> WAPI[üåê OpenWeather API]
    WAPI --> MDB[(üíæ MongoDB)]
    WAPI --> WR[–û—Ç–≤–µ—Ç: –ø–æ–≥–æ–¥–∞]
    W2 --> SJ[sessions.json]

    M -->|–ö–ù–ë| R1[–í—ã–±–æ—Ä –∂–µ—Å—Ç–∞]
    R1 --> R2[rps:pick:<move>]
    R2 --> RLOGIC[üé≤ –õ–æ–≥–∏–∫–∞ –∏–≥—Ä—ã]
    RLOGIC --> RR[–û—Ç–≤–µ—Ç: —Ä–µ–∑—É–ª—å—Ç–∞—Ç]
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏

* `/start` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é.
* –í—Å–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –∏–¥—É—Ç —á–µ—Ä–µ–∑ CallbackQuery.
* –ü–æ–≥–æ–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç, –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è.
* –í—Å–µ —É—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ MongoDB.
* MongoWeiver –¥–æ—Å—Ç—É–ø–µ–Ω.
* –õ–∏–º–∏—Ç 3 –∑–∞–ø—Ä–æ—Å–∞/2 –º–∏–Ω—É—Ç—ã —Ä–∞–±–æ—Ç–∞–µ—Ç.
* –ö–ù–ë —Ä–∞–±–æ—Ç–∞–µ—Ç, –º–æ–∂–Ω–æ –∏–≥—Ä–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ.
* –í—Å—ë –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ Docker.
* –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç.
* –õ–æ–≥–∏ –≤ JSON.
